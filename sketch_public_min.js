var degree,n,nplus1,w_arr,U,points,t_step,arr,drawed,pointsize_arr,mouseymin,mousexmax;function nurbs_weight(e,t){arr.fill(0);for(var n=e+degree;n>=e;--n)if(t>=U[n]){if(U[n]==U[n+1])return 0;arr[n-e]=1;break}var o=1;for(n=degree;n>=1;--n){for(var r=0;r<n;++r){let n=e+r;0!=arr[r]&&(arr[r]=(t-U[n])/(U[n+o]-U[n])*arr[r]),0!=arr[r+1]&&(arr[r]+=(U[n+o+1]-t)/(U[n+o+1]-U[n+1])*arr[r+1])}++o}return arr[0]}function setup(){w_arr=[1,1,1,1,1,1,1],pointsize_arr=[1,1,1,1,1,1,1],t_step=((U=[0,0,0,0,1,2,3,4,4,4,4])[nplus1=(n=6)+1]-U[degree=3])/200;var e=document.getElementById("cvas");createCanvas(e.offsetWidth,e.offsetHeight-4).parent("cvas"),mousexmax=windowWidth-document.getElementById("two").offsetWidth,mouseymin=document.getElementById("leiras").offsetHeight,points=[.1*width,.42*height,.22*width,.22*height,.36*width,.32*height,.46*width,.7*height,.62*width,.83*height,.76*width,.66*height,.84*width,.42*height],noFill(),arr=new Array(degree+1).fill(0),drawed=!1}function draw(){if(!drawed){background(111),strokeWeight(8),stroke(0),beginShape();for(var e=0;e<points.length;e+=2)vertex(points[e],points[e+1]);endShape(),stroke(255,50,50);var t=U[nplus1]-t_step/2;beginShape();for(var o=U[degree];o<t;o+=t_step){let t=0,r=0;for(e=n;;--e)if(o>=U[e]){r=e,t=e-degree;break}let i=0,s=0,a=0;for(e=t;e<=r;++e){let t=nurbs_weight(e,o)*w_arr[e];a+=t,i+=t*points[2*e],s+=t*points[2*e+1]}if(a>0){let e=1/a;vertex(i*e,s*e)}}let r=0,i=0,s=0;for(e=nplus1-degree;e<nplus1;++e){let t=nurbs_weight(e,U[nplus1]-.001)*w_arr[e];s+=t,r+=t*points[2*e],i+=t*points[2*e+1]}if(s>0){let e=1/s;vertex(r*e,i*e)}for(endShape(),stroke(255,255,50),strokeWeight(10),e=degree;e<nplus1;++e){let t=0,n=0,o=0;for(j=e-degree;j<=e;++j){let r=nurbs_weight(j,U[e])*w_arr[j];o+=r,t+=r*points[2*j],n+=r*points[2*j+1]}if(o>0){let e=1/o;point(t*e,n*e)}}stroke(50,255,50);for(e=0;e<points.length;e+=2)0!=pointsize_arr[e/2]&&(strokeWeight(20*pointsize_arr[e/2]),point(points[e],points[e+1]));drawed=!0}}let dragged_point=-1,epsilon=5,on_point=-1;function mouseDragged(){mouseX<=mousexmax&&mouseY>mouseymin&&dragged_point>=0&&(points[dragged_point]=mouseX,points[dragged_point+1]=mouseY,drawed=!1)}function distance(e,t,n,o){let r=e-n,i=t-o;return r*r+i*i}function mousePressed(){if(mouseX<=mousexmax&&mouseY>mouseymin)if(mouseButton===RIGHT){for(var e=0;e<points.length;e+=2)if(distance(points[e],points[e+1],mouseX,mouseY)<=100){dragged_point=e;break}if(-1!=dragged_point){if(1==n)return;points.splice(dragged_point,2),w_arr.splice(dragged_point/2,1),pointsize_arr.splice(dragged_point/2,1),--n,--nplus1;let e=document.getElementsByClassName("knotdiv");e[U.length-2].firstElementChild.max=1e3,e[U.length-1].remove(),U.pop();let t=document.getElementById("idegree");if(--t.max,n==degree){--degree,--t.value;let e=document.getElementsByClassName("knotdiv");e[U.length-2].firstElementChild.max=1e3,e[U.length-1].remove(),U.pop()}drawed=!1}}else if(mouseButton===LEFT){for(e=0;e<points.length;e+=2)if(distance(points[e],points[e+1],mouseX,mouseY)<=100){dragged_point=e;break}if(-1==dragged_point){points.push(mouseX,mouseY),w_arr.push(1),pointsize_arr.push(1),++n,++nplus1,U.push(U[U.length-1]+1);let e=document.getElementById("two").lastElementChild.firstElementChild,t=document.getElementById("two").lastElementChild.cloneNode(!0),o=t.firstElementChild;o.min=e.value,o.max=1e3,o.value=1*o.min+1,o.addEventListener("change",Knotchanged),e.max=o.value,document.getElementById("two").appendChild(t),++document.getElementById("idegree").max,dragged_point=points.length-1,drawed=!1}}}function mouseReleased(){dragged_point=-1}function mouseMoved(){if(mouseX<=mousexmax&&mouseY>mouseymin)for(var e=0;e<points.length;e+=2)if(distance(points[e],points[e+1],mouseX,mouseY)<=100)return void(on_point=e/2);on_point=-1}function mouseWheel(e){return on_point>=0&&(w_arr[on_point]+=e.delta>0?-1:1,w_arr[on_point]<0&&(w_arr[on_point]=0),0==w_arr[on_point]?pointsize_arr[on_point]=0:1==w_arr[on_point]?pointsize_arr[on_point]=1:pointsize_arr[on_point]*=e.delta>0?.9:1.1,drawed=!1),!1}